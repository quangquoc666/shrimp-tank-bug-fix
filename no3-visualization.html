<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr·ª±c quan h√≥a Chu tr√¨nh Nitrogen (T·ªëi ∆∞u cho Di ƒë·ªông & PC)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f0f9ff; /* sky-50 */
        }
        .cycle-node {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 0.75rem; cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(0,0,0,0.1);
            width: 90%; max-width: 320px; z-index: 10;
        }
        .cycle-node:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        /* Desktop-specific styles */
        @media (min-width: 768px) {
            .cycle-node {
                position: absolute;
                width: auto; /* Revert to auto width on desktop */
            }
        }
        .arrow {
            position: absolute; stroke: #60a5fa; stroke-width: 2.5; fill: none;
            marker-end: url(#arrowhead);
            transition: d 0.3s ease;
        }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Scrollbar styling for modals */
        .modal-scrollable-content {
            max-height: 65vh;
            overflow-y: auto;
            padding-right: 1rem; /* Add padding to avoid content hiding behind scrollbar */
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-700">Chu tr√¨nh Nitrogen trong H·ªì th·ªßy sinh</h1>
            <p class="mt-2 text-lg text-slate-600">N√¢ng c·∫•p v·ªõi Tr·ª£ l√Ω AI Gemini</p>
        </header>

        <div id="visualization" class="relative flex flex-col items-center gap-4 md:h-[600px] md:max-w-4xl mx-auto">
            
            <svg id="arrow-svg" width="100%" height="100%" class="hidden md:block absolute top-0 left-0 z-0">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="8" refY="3.5" orient="auto" markerUnits="strokeWidth">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#60a5fa" />
                    </marker>
                </defs>
                <path id="arrow-waste-ammonia" class="arrow"></path>
                <path id="arrow-ammonia-nitrite" class="arrow"></path>
                <path id="arrow-nitrite-nitrate" class="arrow"></path>
                <path id="arrow-nitrate-plant" class="arrow"></path>
                <path id="arrow-nitrate-gas" class="arrow"></path>
            </svg>

            <!-- Cycle Nodes -->
            <div id="node-waste" class="cycle-node bg-amber-100 border-amber-300 md:w-[150px] md:top-[15%] md:left-[10%]">
                <div class="text-2xl">üóëÔ∏è</div><h3 class="font-bold text-amber-800">Ch·∫•t th·∫£i h·ªØu c∆°</h3><p class="text-sm text-amber-700">Th·ª©c ƒÉn th·ª´a, ph√¢n c√°...</p>
            </div>
            <div class="text-3xl text-sky-500 block md:hidden">‚Üì</div>
            <p class="text-sm text-blue-600 block md:hidden">Vi khu·∫©n d·ªã d∆∞·ª°ng</p>
            <div id="node-ammonia" class="cycle-node bg-red-100 border-red-300 md:w-[160px] md:top-[5%] md:left-1/2 md:-translate-x-1/2">
                <div class="text-2xl">‚ò£Ô∏è</div><h3 class="font-bold text-red-800">Amoniac / Amoni</h3><p class="text-sm text-red-700">(NH‚ÇÉ / NH‚ÇÑ‚Å∫) - ƒê·ªôc</p>
            </div>
            <div class="text-3xl text-sky-500 block md:hidden">‚Üì</div>
            <p class="text-sm text-blue-600 block md:hidden">Vi khu·∫©n <em>Nitrosomonas</em></p>
            <div id="node-nitrite" class="cycle-node bg-orange-100 border-orange-300 md:w-[150px] md:top-[35%] md:right-[10%]">
                <div class="text-2xl">‚ö†Ô∏è</div><h3 class="font-bold text-orange-800">Nitrit (NO‚ÇÇ‚Åª)</h3><p class="text-sm text-orange-700">R·∫•t ƒë·ªôc</p>
            </div>
            <div class="text-3xl text-sky-500 block md:hidden">‚Üì</div>
            <p class="text-sm text-blue-600 block md:hidden">Vi khu·∫©n <em>Nitrobacter</em></p>
            <div id="node-nitrate" class="cycle-node bg-teal-100 border-teal-300 md:w-[150px] md:bottom-[20%] md:left-1/2 md:-translate-x-1/2">
                <div class="text-2xl">üíß</div><h3 class="font-bold text-teal-800">Nitrat (NO‚ÇÉ‚Åª)</h3><p class="text-sm text-teal-700">√çt ƒë·ªôc</p>
            </div>
            <div class="text-3xl text-sky-500 block md:hidden">‚Üì</div>
            <p class="text-sm text-blue-600 block md:hidden">ƒê∆∞·ª£c x·ª≠ l√Ω theo 2 c√°ch</p>
            <div class="w-full flex flex-col md:flex-row items-center justify-center gap-4 md:block">
                <div id="node-gas" class="cycle-node bg-sky-100 border-sky-300 md:w-[150px] md:bottom-[20%] md:left-[10%]">
                    <div class="text-2xl">üí®</div><h3 class="font-bold text-sky-800">Kh√≠ Nit∆° (N‚ÇÇ)</h3><p class="text-sm text-sky-700">Kh·ª≠ Nitrat</p>
                </div>
                <div id="node-plant" class="cycle-node bg-green-100 border-green-300 md:w-[160px] md:bottom-[5%] md:right-[10%]">
                    <div class="text-2xl">üåø</div><h3 class="font-bold text-green-800">Th·ª±c v·∫≠t h·∫•p th·ª•</h3><p class="text-sm text-green-700">ƒê·ªìng h√≥a</p>
                </div>
            </div>
        </div>
        
        <p class="text-center mt-8 text-slate-500">üí° Nh·∫•p v√†o m·ªôt giai ƒëo·∫°n b·∫•t k·ª≥ ƒë·ªÉ xem chi ti·∫øt.</p>
        <div class="text-center mt-8">
            <button id="troubleshoot-btn" class="bg-gradient-to-r from-sky-500 to-indigo-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all">
                ‚ú® Tr·ª£ l√Ω X·ª≠ l√Ω S·ª± c·ªë B·ªÉ c√°
            </button>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 invisible">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 md:p-8 w-full max-w-2xl transform scale-95 flex flex-col">
            <div class="flex-shrink-0">
                <div class="flex justify-between items-start">
                    <h2 id="details-modal-title" class="text-2xl font-bold text-sky-700">Ti√™u ƒë·ªÅ</h2>
                    <button id="details-modal-close" class="text-3xl font-light leading-none text-slate-400 hover:text-slate-800">&times;</button>
                </div>
                <hr class="my-4">
            </div>
            <div class="modal-scrollable-content flex-grow">
                <div id="details-modal-body" class="text-slate-700 space-y-3"></div>
                <div class="mt-4 pt-4 border-t">
                    <button id="explain-more-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">‚ú® Gi·∫£i th√≠ch th√™m v·ªõi Gemini</button>
                    <div id="gemini-explanation" class="mt-3 text-sm p-3 bg-blue-50 border border-blue-200 rounded-lg" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Troubleshooter Modal -->
    <div id="troubleshoot-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 invisible">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 md:p-8 w-full max-w-2xl transform scale-95 flex flex-col">
            <div class="flex-shrink-0">
                <div class="flex justify-between items-start">
                    <h2 class="text-2xl font-bold text-sky-700">‚ú® Tr·ª£ l√Ω X·ª≠ l√Ω S·ª± c·ªë</h2>
                    <button id="troubleshoot-modal-close" class="text-3xl font-light leading-none text-slate-400 hover:text-slate-800">&times;</button>
                </div>
                <p class="text-slate-600 mt-1">M√¥ t·∫£ v·∫•n ƒë·ªÅ b·∫°n ƒëang g·∫∑p ph·∫£i v·ªõi h·ªì c√° c·ªßa m√¨nh.</p>
                <hr class="my-4">
            </div>
            <div class="modal-scrollable-content flex-grow">
                <div class="space-y-4">
                    <textarea id="problem-input" class="w-full h-24 p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="V√≠ d·ª•: N∆∞·ªõc h·ªì c·ªßa t√¥i b·ªã ƒë·ª•c v√† c√≥ m√πi tanh..."></textarea>
                    <button id="get-advice-btn" class="w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 transition flex items-center justify-center">
                        Nh·∫≠n l·ªùi khuy√™n t·ª´ Gemini
                    </button>
                    <div id="gemini-advice" class="mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Element References ---
            const detailsModal = document.getElementById('details-modal');
            const detailsModalTitle = document.getElementById('details-modal-title');
            const detailsModalBody = document.getElementById('details-modal-body');
            const detailsModalClose = document.getElementById('details-modal-close');
            const troubleshootBtn = document.getElementById('troubleshoot-btn');
            const troubleshootModal = document.getElementById('troubleshoot-modal');
            const troubleshootModalClose = document.getElementById('troubleshoot-modal-close');
            const getAdviceBtn = document.getElementById('get-advice-btn');
            const problemInput = document.getElementById('problem-input');
            const geminiAdviceContainer = document.getElementById('gemini-advice');
            const explainMoreBtn = document.getElementById('explain-more-btn');
            const geminiExplanationContainer = document.getElementById('gemini-explanation');

            // --- Modal Data (unchanged) ---
            const modalData = {
                'node-waste': { title: 'Giai ƒëo·∫°n 1: Amoniac h√≥a', content: `<p>ƒê√¢y l√† b∆∞·ªõc kh·ªüi ƒë·∫ßu c·ªßa chu tr√¨nh, n∆°i c√°c h·ª£p ch·∫•t nit∆° h·ªØu c∆° ƒë∆∞·ª£c chuy·ªÉn ƒë·ªïi th√†nh amoniac (NH‚ÇÉ) ho·∫∑c ion amoni (NH‚ÇÑ‚Å∫).</p><ul class="list-disc list-inside mt-2 space-y-1"><li><strong>Ngu·ªìn g·ªëc:</strong> Ch·∫•t th·∫£i c·ªßa c√°, th·ª©c ƒÉn th·ª´a, x√°c th·ª±c v·∫≠t/ƒë·ªông v·∫≠t ph√¢n h·ªßy.</li><li><strong>Qu√° tr√¨nh:</strong> Vi khu·∫©n d·ªã d∆∞·ª°ng v√† n·∫•m ph√¢n h·ªßy c√°c h·ª£p ch·∫•t h·ªØu c∆° n√†y.</li><li><strong>Ph·∫£n ·ª©ng:</strong> <code class="bg-slate-100 p-1 rounded">Ch·∫•t h·ªØu c∆° ‚Üí NH‚ÇÉ / NH‚ÇÑ‚Å∫</code></li></ul>`},
                'node-ammonia': { title: 'Chuy·ªÉn h√≥a Amoniac th√†nh Nitrit', content: `<p>ƒê√¢y l√† b∆∞·ªõc ƒë·∫ßu ti√™n c·ªßa qu√° tr√¨nh Nitrat h√≥a, ƒë∆∞·ª£c th·ª±c hi·ªán b·ªüi vi khu·∫©n hi·∫øu kh√≠.</p><ul class="list-disc list-inside mt-2 space-y-1"><li><strong>Vi khu·∫©n:</strong> Chi <em>Nitrosomonas</em>.</li><li><strong>M√¥ t·∫£:</strong> Vi khu·∫©n oxy h√≥a amoniac ƒë·ªÉ t·∫°o nƒÉng l∆∞·ª£ng, s·∫£n ph·∫©m ph·ª• l√† Nitrit (NO‚ÇÇ‚Åª).</li><li><strong>ƒê·ªôc t√≠nh:</strong> Amoniac (NH‚ÇÉ) r·∫•t ƒë·ªôc, ƒë·∫∑c bi·ªát khi pH > 7.</li><li><strong>Ph∆∞∆°ng tr√¨nh:</strong> <code class="bg-slate-100 p-1 rounded">2NH‚ÇÑ‚Å∫ + 3O‚ÇÇ ‚Üí 2NO‚ÇÇ‚Åª + 4H‚Å∫ + 2H‚ÇÇO</code></li></ul>`},
                'node-nitrite': { title: 'Chuy·ªÉn h√≥a Nitrit th√†nh Nitrat', content: `<p>ƒê√¢y l√† b∆∞·ªõc th·ª© hai c·ªßa qu√° tr√¨nh Nitrat h√≥a.</p><ul class="list-disc list-inside mt-2 space-y-1"><li><strong>Vi khu·∫©n:</strong> Chi <em>Nitrobacter</em>.</li><li><strong>M√¥ t·∫£:</strong> Vi khu·∫©n <em>Nitrobacter</em> nhanh ch√≥ng oxy h√≥a Nitrit th√†nh Nitrat (NO‚ÇÉ‚Åª).</li><li><strong>ƒê·ªôc t√≠nh:</strong> Nitrit (NO‚ÇÇ‚Åª) v·∫´n c√≤n r·∫•t ƒë·ªôc, g√¢y ng·∫°t cho c√°.</li><li><strong>Ph∆∞∆°ng tr√¨nh:</strong> <code class="bg-slate-100 p-1 rounded">2NO‚ÇÇ‚Åª + O‚ÇÇ ‚Üí 2NO‚ÇÉ‚Åª</code></li></ul>`},
                'node-nitrate': { title: 'Giai ƒëo·∫°n cu·ªëi: Nitrat (NO‚ÇÉ‚Åª)', content: `<p>Nitrat l√† s·∫£n ph·∫©m cu·ªëi c√πng c·ªßa qu√° tr√¨nh nitrat h√≥a v√† √≠t ƒë·ªôc h∆°n nhi·ªÅu. N√≥ ƒë∆∞·ª£c lo·∫°i b·ªè kh·ªèi h·ªì theo hai c√°ch ch√≠nh:</p><ul class="list-disc list-inside mt-2 space-y-1"><li><strong>ƒê·ªìng h√≥a:</strong> Th·ª±c v·∫≠t th·ªßy sinh v√† t·∫£o h·∫•p th·ª• Nitrat l√†m dinh d∆∞·ª°ng.</li><li><strong>Kh·ª≠ Nitrat:</strong> Vi khu·∫©n y·∫øm kh√≠ ph√¢n gi·∫£i Nitrat th√†nh kh√≠ Nit∆° (N‚ÇÇ).</li></ul><p class="mt-2">Thay n∆∞·ªõc ƒë·ªãnh k·ª≥ c≈©ng l√† m·ªôt c√°ch hi·ªáu qu·∫£ ƒë·ªÉ gi·∫£m n·ªìng ƒë·ªô Nitrat.</p>`},
                'node-plant': { title: 'ƒê·ªìng h√≥a b·ªüi Th·ª±c v·∫≠t', content: `<p>ƒê√¢y l√† c√°ch t·ª± nhi√™n nh·∫•t ƒë·ªÉ lo·∫°i b·ªè Nitrat (NO‚ÇÉ‚Åª) ra kh·ªèi h·ªì.</p><ul class="list-disc list-inside mt-2 space-y-1"><li><strong>C∆° ch·∫ø:</strong> Th·ª±c v·∫≠t v√† t·∫£o s·ª≠ d·ª•ng Nitrat l√†m dinh d∆∞·ª°ng ƒë·ªÉ ph√°t tri·ªÉn.</li><li><strong>Ph·∫£n ·ª©ng:</strong> <code class="bg-slate-100 p-1 rounded">NO‚ÇÉ‚Åª ‚Üí Sinh kh·ªëi th·ª±c v·∫≠t</code></li><li><strong>L·ª£i √≠ch:</strong> Gi√∫p ki·ªÉm so√°t Nitrat, h·∫°n ch·∫ø r√™u h·∫°i.</li></ul>`},
                'node-gas': { title: 'Kh·ª≠ Nitrat (Denitrification)', content: `<p>ƒê√¢y l√† qu√° tr√¨nh sinh h·ªçc chuy·ªÉn ƒë·ªïi Nitrat (NO‚ÇÉ‚Åª) tr·ªü l·∫°i th√†nh kh√≠ Nit∆° (N‚ÇÇ).</p><ul class="list-disc list-inside mt-2 space-y-1"><li><strong>C∆° ch·∫ø:</strong> Vi khu·∫©n k·ªµ kh√≠ s·ª≠ d·ª•ng Nitrat thay cho oxy ƒë·ªÉ h√¥ h·∫•p.</li><li><strong>ƒêi·ªÅu ki·ªán:</strong> X·∫£y ra ·ªü v√πng y·∫øm kh√≠ nh∆∞ n·ªÅn d√†y, v·∫≠t li·ªáu l·ªçc x·ªëp.</li><li><strong>Ph∆∞∆°ng tr√¨nh:</strong> <code class="bg-slate-100 p-1 rounded">2NO‚ÇÉ‚Åª ‚Üí N‚ÇÇ (kh√≠)</code></li></ul>`}
            };

            // --- Gemini API Call Function (unchanged) ---
            async function callGeminiAPI(prompt, outputContainer, buttonToDisable) {
                outputContainer.style.display = 'block';
                outputContainer.innerHTML = '<div class="flex justify-center items-center"><div class="loader"></div><p class="ml-3 text-slate-500">Gemini ƒëang suy nghƒ©...</p></div>';
                if (buttonToDisable) buttonToDisable.disabled = true;
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { throw new Error(`API Error: ${response.statusText}`); }
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        let htmlText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>');
                        outputContainer.innerHTML = htmlText;
                    } else {
                        outputContainer.innerHTML = '<p class="text-red-500">Xin l·ªói, kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h·ª£p l·ªá t·ª´ Gemini.</p>';
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    outputContainer.innerHTML = `<p class="text-red-500">ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi v·ªõi Gemini. Vui l√≤ng th·ª≠ l·∫°i sau. L·ªói: ${error.message}</p>`;
                } finally {
                    if (buttonToDisable) buttonToDisable.disabled = false;
                }
            }

            // --- Modal Control Functions (unchanged) ---
            function showModal(modal) {
                modal.classList.remove('invisible', 'opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }
            function hideModal(modal) {
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => modal.classList.add('invisible'), 300);
            }

            // --- Event Listeners (unchanged) ---
            document.querySelectorAll('.cycle-node').forEach(node => {
                node.addEventListener('click', () => {
                    const data = modalData[node.id];
                    if (!data) return;
                    detailsModalTitle.textContent = data.title;
                    detailsModalBody.innerHTML = data.content;
                    geminiExplanationContainer.style.display = 'none';
                    geminiExplanationContainer.innerHTML = '';
                    explainMoreBtn.dataset.context = data.title;
                    showModal(detailsModal);
                });
            });
            detailsModalClose.addEventListener('click', () => hideModal(detailsModal));
            troubleshootBtn.addEventListener('click', () => showModal(troubleshootModal));
            troubleshootModalClose.addEventListener('click', () => hideModal(troubleshootModal));
            getAdviceBtn.addEventListener('click', () => {
                const problem = problemInput.value.trim();
                if (!problem) {
                    geminiAdviceContainer.style.display = 'block';
                    geminiAdviceContainer.innerHTML = '<p class="text-orange-500">Vui l√≤ng m√¥ t·∫£ v·∫•n ƒë·ªÅ b·∫°n ƒëang g·∫∑p ph·∫£i.</p>';
                    return;
                }
                const prompt = `B·∫°n l√† m·ªôt chuy√™n gia h·ªì th·ªßy sinh, chuy√™n s√¢u v·ªÅ chu tr√¨nh nitrogen. Ng∆∞·ªùi d√πng ƒëang g·∫∑p s·ª± c·ªë v·ªõi h·ªì c√° c·ªßa h·ªç. V·∫•n ƒë·ªÅ c·ªßa h·ªç l√†: "${problem}". D·ª±a v√†o th√¥ng tin n√†y, h√£y gi·∫£i th√≠ch c√°c nguy√™n nh√¢n c√≥ th·ªÉ li√™n quan ƒë·∫øn chu tr√¨nh nitrogen, giai ƒëo·∫°n n√†o c·ªßa chu tr√¨nh c√≥ th·ªÉ b·ªã ·∫£nh h∆∞·ªüng, v√† cung c·∫•p c√°c gi·∫£i ph√°p kh·∫Øc ph·ª•c r√µ r√†ng, t·ª´ng b∆∞·ªõc m·ªôt. Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát.`;
                callGeminiAPI(prompt, geminiAdviceContainer, getAdviceBtn);
            });
            explainMoreBtn.addEventListener('click', (e) => {
                const context = e.target.dataset.context;
                if (!context) return;
                const prompt = `B·∫°n l√† m·ªôt gi√°o vi√™n khoa h·ªçc th√¢n thi·ªán. H√£y gi·∫£i th√≠ch kh√°i ni·ªám "${context}" trong chu tr√¨nh nitrogen c·ªßa h·ªì th·ªßy sinh m·ªôt c√°ch th·∫≠t ƒë∆°n gi·∫£n, d·ªÖ hi·ªÉu cho ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu. C√≥ th·ªÉ d√πng c√°c v√≠ d·ª• so s√°nh, ·∫©n d·ª• n·∫øu c·∫ßn. Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát.`;
                callGeminiAPI(prompt, geminiExplanationContainer, explainMoreBtn);
            });
            [detailsModal, troubleshootModal].forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) { hideModal(modal); } });
            });
            
            // --- NEW: Dynamic Arrow Drawing Logic ---
            function drawArrows() {
                if (window.innerWidth < 768) {
                    // Don't draw arrows on mobile
                    document.getElementById('arrow-svg').style.display = 'none';
                    return;
                }
                document.getElementById('arrow-svg').style.display = 'block';

                const container = document.getElementById('visualization');
                const containerRect = container.getBoundingClientRect();

                function getCenter(nodeId) {
                    const node = document.getElementById(nodeId);
                    const nodeRect = node.getBoundingClientRect();
                    return {
                        x: nodeRect.left - containerRect.left + nodeRect.width / 2,
                        y: nodeRect.top - containerRect.top + nodeRect.height / 2
                    };
                }

                function drawCurve(arrowId, startNodeId, endNodeId, curveFactor = 0) {
                    const arrow = document.getElementById(arrowId);
                    const start = getCenter(startNodeId);
                    const end = getCenter(endNodeId);
                    
                    const midX = (start.x + end.x) / 2;
                    const midY = (start.y + end.y) / 2;
                    
                    const controlX = midX + (end.y - start.y) * curveFactor;
                    const controlY = midY - (end.x - start.x) * curveFactor;
                    
                    arrow.setAttribute('d', `M ${start.x} ${start.y} Q ${controlX} ${controlY} ${end.x} ${end.y}`);
                }

                drawCurve('arrow-waste-ammonia', 'node-waste', 'node-ammonia', 0.2);
                drawCurve('arrow-ammonia-nitrite', 'node-ammonia', 'node-nitrite', 0.2);
                drawCurve('arrow-nitrite-nitrate', 'node-nitrite', 'node-nitrate', -0.2);
                drawCurve('arrow-nitrate-plant', 'node-nitrate', 'node-plant', 0.2);
                drawCurve('arrow-nitrate-gas', 'node-nitrate', 'node-gas', -0.2);
            }

            // Initial draw and redraw on resize
            setTimeout(drawArrows, 100); // A small delay to ensure layout is stable
            window.addEventListener('resize', drawArrows);
        });
    </script>
</body>
</html>
